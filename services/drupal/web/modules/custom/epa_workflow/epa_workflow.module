<?php

/**
 * @file
 * Contains epa_workflow.module.
 */

use Drupal\content_moderation\Entity\ContentModerationStateInterface;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Field\BaseFieldDefinition;

/**
 * Implements hook_entity_base_field_info().
 */
function epa_workflow_entity_base_field_info(EntityTypeInterface $entity_type) {
  if (\Drupal::service('content_moderation.moderation_information')->isModeratedEntityType($entity_type)) {
    $fields['epa_workflow_automated'] = BaseFieldDefinition::create('boolean')
      ->setLabel(t('Moderation automated'))
      ->setDescription(t('When true current moderation state is automated.'))
      ->setComputed(TRUE)
      ->setRevisionable(TRUE);
    return $fields;
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function epa_workflow_content_moderation_state_insert(ContentModerationStateInterface $entity) {
  epa_workflow_automate_moderation($entity);
}

/**
 * Implements hook_ENTITY_TYPE_update().
 *
 * @see Drupal\group\Entity\GroupContent::postSave
 * @see https://www.drupal.org/project/group/issues/2872697
 * @see https://www.drupal.org/project/drupal/issues/2803717
 */
function epa_workflow_content_moderation_state_update(ContentModerationStateInterface $entity) {
  // Group will trigger an update after insert.
  // Check to see if content revision id has changed.
  // Also, check that the moderation state isn't looping over itself.
  if ($entity->content_entity_revision_id->value != $entity->original->content_entity_revision_id->value
      && $entity->getRevisionId() != $entity->getLoadedRevisionId()
  ) {
    epa_workflow_automate_moderation($entity);
  }
}

/**
 * Triggers events based on content moderation state.
 */
function epa_workflow_automate_moderation(ContentModerationStateInterface $entity) {
  $state = $entity->moderation_state->value;
  switch ($state) {
    case 'draft_approved':
      epa_workflow_on_enter_draft_approved($entity);
      break;

    case 'published':
      epa_workflow_on_enter_published($entity);
      break;
  }
}

/**
 * Performs actions when a draft is approved.
 */
function epa_workflow_on_enter_draft_approved(ContentModerationStateInterface $entity) {
  // If publish date entered, schedule content to be published.
  epa_workflow_schedule_transition($entity, 'field_publish_date', 'published');

  // Delete this. This is just for testing.
  // Get content entity.
  $content_entity_type = $entity->content_entity_type_id->value;

  $content_entity_revision_id = $entity->content_entity_revision_id->value;
  /**
   * @var Drupal\Core\Entity\ContentEntityInterface $content_entity_revision
   */
  $content_entity_revision = \Drupal::entityTypeManager()->getStorage($content_entity_type)->loadRevision($content_entity_revision_id);
  $field_publish_date = $content_entity_revision->get('field_publish_date');
  $settings = $field_publish_date->getSettings();
  $itemdef = $field_publish_date->getItemDefinition();
  $fielddef = $field_publish_date->getFieldDefinition();
  $date = $field_publish_date->getValue();
  $next_date = '';

  \Drupal::logger('epa_workflow')->info('Content was transitioned to draft approved');
}

/**
 * Performs actions when content is published.
 */
function epa_workflow_on_enter_published(ContentModerationStateInterface $entity) {
  // If sunset date entered, schedule content to be unpublished.
  epa_workflow_schedule_transition($entity, 'field_expiration_date', 'unpublished');

  // Set review date field.
  epa_workflow_set_review_deadline($entity);

  \Drupal::logger('epa_workflow')->info('Content was transitioned to published');
}

/**
 * Transfer date to schedule transition.
 *
 * @todo Refactor to use helper function to retrieve content entity revision.
 */
function epa_workflow_schedule_transition(ContentModerationStateInterface $entity, $date_field, $moderation_state) {
  // Get content entity.
  $content_entity_type = $entity->content_entity_type_id->value;

  $content_entity_revision_id = $entity->content_entity_revision_id->value;
  /**
   * @var Drupal\Core\Entity\ContentEntityInterface $content_entity_revision
   */
  $content_entity_revision = \Drupal::entityTypeManager()->getStorage($content_entity_type)->loadRevision($content_entity_revision_id);

  // Stop if content doesn't have a publish date.
  if (!$content_entity_revision->hasField($date_field) || $content_entity_revision->get($date_field)->isEmpty()) {
    return;
  }

  // Do not create a new revision and set scheduled transition.
  // Mark scheduled transition as automated.
  $content_entity_revision->setSyncing(TRUE);
  $content_entity_revision->set('field_scheduled_transition', [
    'moderation_state' => $moderation_state,
    'value' => $content_entity_revision->{$date_field}->value,
  ]);
  $content_entity_revision->save();
}

/**
 * Sets field_review_deadline value based on metadata type.
 *
 * @todo Refactor to use helper function to retrieve content entity revision.
 */
function epa_workflow_set_review_deadline($entity, $reset = FALSE) {
  // Get content entity.
  $content_entity_type = $entity->content_entity_type_id->value;

  $content_entity_revision_id = $entity->content_entity_revision_id->value;
  /**
   * @var Drupal\Core\Entity\ContentEntityInterface $content_entity_revision
   */
  $content_entity_revision = \Drupal::entityTypeManager()->getStorage($content_entity_type)->loadRevision($content_entity_revision_id);

  // Stop if content use a review deadline.
  if (!$content_entity_revision->hasField('field_review_deadline') || $content_entity_revision->get('field_review_deadline')->isEmpty()) {
    return;
  }

  $content_entity_revision->setSyncing(TRUE);

  if ($reset) {
    $content_entity_revision->set('field_review_deadline', NULL);
    $content_entity_revision->save();
    return $content_entity_revision;
  }

  if (!$content_entity_revision->get('field_type')->isEmpty() && $type->field) {

  }

}
